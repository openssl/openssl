name: "Trigger docs.openssl.org deployment"

on:
  push:
    branches:
      - "openssl-3.[0-9]+"
      - "master"
    paths:
      - "doc/man*/**"

jobs:
  trigger:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1  # Prevent concurrent runs from interfering
      fail-fast: false
      matrix:
        attempt: [1, 2, 3]  # Allow up to 3 automatic retries

    steps:
      - name: "Ensure GitHub CLI is installed"
        run: |
          if ! command -v gh &>/dev/null; then
            echo "GitHub CLI not found. Installing..."
            sudo apt update && sudo apt install -y gh
          else
            echo "GitHub CLI is already installed."
          fi

      - name: "Trigger deployment workflow (Attempt ${{ matrix.attempt }})"
        env:
          GH_REPO: "openssl/openssl-docs"
          GH_TOKEN: ${{ secrets.OPENSSL_MACHINE_TOKEN }}
        run: |
          echo "üîÑ Starting deployment (Attempt ${{ matrix.attempt }}/3)..."

          # Exponential backoff retry function
          retry() {
            local max_attempts=5
            local attempt=1
            local delay=5  # Start with 5s delay

            while [ $attempt -le $max_attempts ]; do
              "$@" && return 0  # Exit if command succeeds
              exit_code=$?
              echo "‚ö†Ô∏è Attempt $attempt/$max_attempts failed. Retrying in $delay seconds..."
              sleep $delay
              delay=$((delay * 2))  # Exponential backoff
              attempt=$((attempt + 1))
            done

            echo "‚ùå Command failed after $max_attempts attempts: $*"
            exit $exit_code
          }

          echo "üöÄ Triggering deployment workflow..."
          retry gh workflow run deploy-site.yaml -f branch=${{ github.ref_name }}

          echo "‚è≥ Waiting for workflow to start..."
          sleep 5  # Allow GitHub to initialize the workflow

          echo "üìå Fetching latest run ID..."
          RUN_ID=""
          for i in {1..5}; do
            RUN_ID=$(gh run list -w deploy-site.yaml -L 1 --json databaseId -q ".[0].databaseId" 2>/dev/null)
            if [[ -n "$RUN_ID" ]]; then
              break
            fi
            echo "üîÑ Retrying to fetch RUN_ID ($i/5)..."
            sleep $((i * 3))  # Gradual backoff
          done

          if [[ -z "$RUN_ID" ]]; then
            echo "‚ùå ERROR: Failed to retrieve workflow run ID. Exiting."
            exit 1
          fi

          echo "‚úÖ Deployment workflow started (Run ID: $RUN_ID). Watching progress..."
          gh run watch "$RUN_ID" --exit-status || {
            echo "‚ùå Deployment workflow failed. Check logs above for details."
            exit 1
          }

      - name: "Notify on Failure (Optional)"
        if: failure()
        run: |
          echo "üö® Deployment failed on attempt ${{ matrix.attempt }}/3. Consider adding Slack/email notifications here."
