#! /usr/bin/env perl
# Copyright 2025 The OpenSSL Project Authors. All Rights Reserved.
#
# Licensed under the Apache License 2.0 (the "License").  You may not use
# this file except in compliance with the License.  You can obtain a copy
# in the file LICENSE in the source distribution or at
# https://www.openssl.org/source/license.html


use strict;
use warnings;

use File::Spec;
use OpenSSL::Test::Utils;
use OpenSSL::Test qw/:DEFAULT srctop_file/;

setup("test_platcert");

plan tests => 164;

require_ok(srctop_file("test", "recipes", "tconversion.pl"));

my @certs = qw(test certs);

my @pkc1_expectations = (
"\QTCG Credential Type:\E",
"\QCredential Type: 2.23.133.8.2 (Platform Attribute Certificate)\E",
"\QTCG Platform Manufacturer ID:\E",
"\QManufacturer Identifier: 1.3.6.1.4.1.56490 (undefined)\E",
"\QTCG Credential Specification:\E",
"\Q2.0.0\E",
"\QTPM Platform Specification:\E",
"\Q2.0.0 : 7D:D0:EE:8D\E",
"\QTCG Platform Configuration URI:\E",
"\QURI: https://example.com/uri-reference\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: 49:28:77:9C:4E:8F:80:37:85:90:73:A5:0E:CC:FC:88:01:5C:4A:14:76:13:9B:B4:6A:B4:2C:73:DF:77:50:16\E",
"\QTBB Security Assertions:\E",
"\QVersion: 2\E",
"\QCommon Criteria Measures:\E",
"\QVersion: 3.1\E",
"\QAssurance Level: Level 2\E",
"\QEvaluation Status: Designed To Meet (0)\E",
"\QPlus: TRUE\E",
"\QStrength Of Function: Basic (0)\E",
"\QProfile OID: 1.3.4.1.6.1.56940 (undefined)\E",
"\QProfile URI:\E",
"\QURI: https://example2.com/profile-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: D5:A0:7D:88:E3:06:F0:5E:A4:4B:75:99:AF:21:AF:D5:7F:11:B4:41:48:7D:08:E2:5C:E7:14:48:0E:86:C6:5D\E",
"\QTarget OID: 1.3.4.1.6.1.56940 (undefined)\E",
"\QTarget URI:\E",
"\QURI: https://example2.com/target-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: 9A:9B:6D:23:E9:4E:5B:F2:72:B7:90:1E:69:8D:9D:4A:06:AB:3C:48:ED:2A:EB:67:E0:77:27:3D:7B:5D:4F:E7\E",
"\QFIPS Level:\E",
"\QVersion: 140-2\E",
"\QLevel: Level 2\E",
"\QPlus: TRUE\E",
"\QRoot Measurement Type: Physical (4)\E",
"\QISO 9001 URI: https://mycompany.com/iso-certification\E",
"\QPlatform Configuration Version 2:\E",
"\QComponent Identifiers:\E",
"\QComponent Identifier:\E",
"\QComponent Class:\E",
"\QComponent Class Registry: 2.23.133.18.3.2 (Internet Engineering Task Force Registry)\E",
"\QComponent Class Registry: 03:07:05:01\E",
"\QComponent Manufacturer: ASUS\E",
"\QComponent Model: QX-80\E",
"\QComponent Serial: A205250-026820\E",
"\QComponent Revision: 25\E",
"\QComponent Manufacturer ID: 1.3.4.1.6.1.56940 (undefined)\E",
"\QField Replaceable: TRUE\E",
"\QComponent Addresses:\E",
"\QComponent Address:\E",
"\QAddress Type: 2.23.133.17.3 (Bluetooth MAC Address)\E",
"\QAddress Value: 08:42:64:08:24:10\E",
"\QComponent Address:\E",
"\QAddress Type: 2.23.133.17.3 (Bluetooth MAC Address)\E",
"\QAddress Value: 08:42:64:08:24:11\E",
"\QComponent Platform Certificate:\E",
"\QHashed Certificate Identifier:\E",
"\QHash Algorithm:\E",
"\QHash Algorithm: sha256\E",
"\QHash Over Signature Value: 9A:99:72:7A:4C:A6:9B:1D:A7:55:6D:54:B9:3E:CD:80:62:45:CC:3D:A0:49:ED:81:A7:62:DD:D4:11:E8:63:3C\E",
"\QGeneric Certificate Identifier:\E",
"\QIssuer Names:\E",
"\QDirName:CN = skeletor\E",
"\QIssuer Serial: 0x1FFE8F65127985EE\E",
"\QIssuer UID: F395\E",
"\QComponent Platform Certificate URI:\E",
"\QURI: https://example4.com/component-platform-cert-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: EA:BC:8A:3A:68:45:6A:71:FA:A2:9F:4C:58:2E:F5:02:6A:96:3B:2F:7C:38:F5:F0:B6:6A:7F:67:6D:6A:FC:2A\E",
"\QStatus: Added (0)\E",
"\QComponent Identifier URI:\E",
"\QURI: https://example3.com/component-identifiers-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: 4F:71:4F:C7:E2:4D:F3:D7:C9:B8:78:40:C2:8E:53:8D:3F:8E:0E:E3:78:CB:F9:D6:65:C1:2F:55:1D:8D:6D:65\E",
"\QProperties:\E",
"\QProperty Name: flavor\E",
"\QProperty Value: strawberry\E",
"\QStatus: Removed (2)\E",
"\QProperty Name: flavor\E",
"\QProperty Value: chocolate\E",
"\QStatus: Added (0)\E",
"\QPlatform Properties URI:\E",
"\QURI: https://example3.com/platform-properties-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: 36:AF:24:52:C1:7F:68:91:9F:BA:BC:22:D5:10:87:92:A5:06:58:16:9B:35:0F:88:B1:AF:02:47:19:45:21:07\E"
);

my @pkc2_expectations = (
"\QX509v3 Subject Directory Attributes: critical\E",
"\QTCG Credential Type:\E",
"\Q2.23.133.8.2 (Platform Attribute Certificate)\E",
"\QTCG Credential Specification:\E",
"\Q2.0.0\E",
"\QTPM Platform Specification:\E",
"\Q2.0.0 : AF:47:C8:FB\E",
"\QTCG TBB Security Assertions V3:\E",
"\QTrait ID: 2.23.133.19.1.6 (FIPS Level Trait)\E",
"\QTrait Category: 2.23.133.19.2.27 (FIPS Level Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait Description: FIPS Level\E",
"\QTrait Description URI: https://example.com/fipslevel\E",
"\QVersion: 140-2\E",
"\QLevel: Level 1\E",
"\QPlus: TRUE\E",
"\QTrait ID: 2.23.133.19.1.7 (ISO 9000 Level Trait)\E",
"\QTrait Category: 2.23.133.19.2.25 (Common Criteria Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait Description: Common Criteria\E",
"\QISO 9000 Certified: TRUE\E",
"\QISO 9000 Certification URI: https://quality.com/iso9001\E",
"\QTrait ID: 2.23.133.19.1.11 (Platform Firmware Capabilities Trait)\E",
"\QTrait Category: 2.23.133.19.2.32 (Platform Firmware Capabilities Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.12 (Platform Firmware Signature Verification Trait)\E",
"\QTrait Category: 2.23.133.19.2.34 (Platform Firmware Signature Verification Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.13 (Platform Firmware Update Compliance Trait)\E",
"\QTrait Category: 2.23.133.19.2.35 (Platform Firmware Update Compliance Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.14 (Platform Hardware Capabilities Trait)\E",
"\QTrait Category: 2.23.133.19.2.33 (Platform Hardware Capabilities Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.15 (Root of Trust for Measurement Trait)\E",
"\QTrait Category: 2.23.133.19.2.36 (Root of Trust of Measurement Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.3 (Common Criteria Trait)\E",
"\QTrait Category: 2.23.133.19.2.25 (Common Criteria Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait Description: Common Criteria\E",
"\QCommon Criteria Measures:\E",
"\QVersion: 3.1\E",
"\QAssurance Level: Level 2\E",
"\QEvaluation Status: Designed To Meet (0)\E",
"\QPlus: TRUE\E",
"\QStrength Of Function: Basic (0)\E",
"\QProfile OID: 1.3.4.1.6.1.56940 (undefined)\E",
"\QProfile URI:\E",
"\QURI: https://example2.com/profile-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: BD:79:DD:55:6B:15:DA:16:11:AF:89:33:44:65:32:48:7B:60:21:3D:64:99:3D:73:F0:19:98:72:9A:27:3F:0A\E",
"\QTarget OID: 1.3.4.1.6.1.56940 (undefined)\E",
"\QTarget URI:\E",
"\QURI: https://example2.com/target-uri\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: 79:51:F6:3D:B0:65:75:39:EE:A0:4B:08:93:FB:B8:BF:AC:06:B1:8A:6A:5D:0C:2A:28:3C:A2:5F:AA:C3:D6:4B\E",
"\QCommon Criteria Cert. No.: 52-85-28522\E",
"\QCommon Criteria Cert. Authority: Goofy Authority\E",
"\QEvaluation Scheme: Gut Instinct\E",
"\QCommon Criteria Cert. Issue Date: Feb 20 12:32:08 2025 GMT\E",
"\QCommon Criteria Cert. Expiry Date: Feb 20 12:32:08 2025 GMT\E",
"\QTCG Previous Platform Certificates:\E",
"\QTrait ID: 2.23.133.19.1.20 (PEM-Encoded Certificate String Trait)\E",
"\QTrait Category: 2.23.133.19.2.21 (Platform Certificate Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.20 (PEM-Encoded Certificate String Trait)\E",
"\QTrait Category: 2.23.133.19.2.21 (Platform Certificate Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTCG Cryptographic Anchors:\E",
"\QTrait ID: 2.23.133.19.1.21 (Public Key Trait)\E",
"\QTrait Category: 2.23.133.19.2.37 (Public Key Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait Value:\E",
"\QPublic Key Algorithm: rsaEncryption\E",
"\QPublic-Key: (2048 bit)\E",
"\QModulus:\E",
"\Q00:8e:4e:08:1b:96:e5:8f:15:4e:1d:fc:13:66:1f:\E",
"\Q8b:5c:5f:63:c8:69:5a:2c:b8:86:da:35:c3:42:8f:\E",
"\Qd9:a7:f5:aa:8d:0b:d2:a9:90:84:16:95:9c:74:e9:\E",
"\Qe0:cd:f4:75:a2:cc:ee:1c:2c:40:f4:07:39:54:c9:\E",
"\Q93:13:d2:99:15:44:5f:86:3d:58:19:26:ac:8b:c9:\E",
"\Qc4:4e:83:fb:27:f7:55:99:03:96:12:fe:5a:17:25:\E",
"\Qd5:aa:4b:39:f6:fc:e1:08:18:bc:cf:6b:01:7c:83:\E",
"\Qf4:05:e3:3b:f6:33:32:87:ed:24:8a:01:f6:9a:8b:\E",
"\Q5b:ef:a6:90:3a:5a:99:e4:04:18:a3:d4:ac:15:06:\E",
"\Qe4:ae:76:42:f9:27:ba:6e:ac:f2:72:f7:55:d0:5d:\E",
"\Qcb:b6:4c:5a:20:2b:25:c0:bf:2b:75:9b:a8:08:41:\E",
"\Q8e:16:9f:a4:68:90:52:60:22:cb:60:4a:22:e7:e7:\E",
"\Q00:f9:27:af:72:17:9c:17:45:de:c7:cf:19:ec:b9:\E",
"\Q36:86:9a:61:82:e0:fc:f7:06:d9:1f:9d:4b:e1:16:\E",
"\Q03:ff:6e:44:94:f4:bf:51:e4:a8:a2:7d:11:86:7e:\E",
"\Qfa:c4:f7:b0:79:40:10:33:76:b2:eb:d0:89:79:86:\E",
"\Q71:65:49:21:e1:70:f1:5f:3b:5a:55:0f:cf:c8:01:\E",
"\Q0f:c7\E",
"\QExponent: 65537 (0x10001)\E",
"\QPlatform Configuration Version 3:\E",
"\QPlatform Components:\E",
"\QPlatform Component (Traits):\E",
"\QTrait ID: 2.23.133.19.1.4 (Component Class Trait)\E",
"\QTrait Category: 2.23.133.19.2.7 (Component Class Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QBD:88:66:21\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.8 (Component Manufacturer Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QWildboar Software\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.9 (Component Model Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QQX-80\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.10 (Component Serial Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\Q1095701957\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.13 (Component Revision Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.1 (Boolean Trait)\E",
"\QTrait Category: 2.23.133.19.2.14 (Component Field Replaceable Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QFALSE\E",
"\QTrait ID: 2.23.133.19.1.16 (Attribute Status Trait)\E",
"\QTrait Category: 2.23.133.19.2.11 (Component Status Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QPlatform Component (Traits):\E",
"\QTrait ID: 2.23.133.19.1.4 (Component Class Trait)\E",
"\QTrait Category: 2.23.133.19.2.7 (Component Class Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QBD:88:66:21\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.8 (Component Manufacturer Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QWildboar Software\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.9 (Component Model Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QQX-80\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.10 (Component Serial Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\Q1095701957\E",
"\QTrait ID: 2.23.133.19.1.18 (UTF8String Trait)\E",
"\QTrait Category: 2.23.133.19.2.13 (Component Revision Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait ID: 2.23.133.19.1.1 (Boolean Trait)\E",
"\QTrait Category: 2.23.133.19.2.14 (Component Field Replaceable Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QFALSE\E",
"\QTrait ID: 2.23.133.19.1.16 (Attribute Status Trait)\E",
"\QTrait Category: 2.23.133.19.2.11 (Component Status Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QPlatform Properties:\E",
"\QPlatform Property:\E",
"\QProperty Name: ingredient\E",
"\QProperty Value: cranberries\E",
"\QStatus: Added (0)\E",
"\QPlatform Property:\E",
"\QProperty Name: ingredient\E",
"\QProperty Value: walnuts\E",
"\QStatus: Removed (2)\E",
"\QPlatform Configuration URI Version 3:\E",
"\QTrait ID: 2.23.133.19.1.17 (Uniform Resource Identifier Trait)\E",
"\QTrait Category: 2.23.133.19.2.12 (Component Location Trait Category)\E",
"\QTrait Registry: 2.23.133.19.3 (TCG Trait Registries)\E",
"\QTrait Value:\E",
"\QURI: https://qiwrgh.com/63081\E",
"\QHash Algorithm: sha256\E",
"\QHash Value: 28:26:EE:A5:20:88:E4:26:D0:AF:C2:EA:8C:8B:7F:76:40:1B:EC:6E:BB:42:FF:C2:42:FA:D1:37:47:D0:F3:47\E"
);

cert_contains_all(srctop_file(@certs, "platcertv1.cert.pem"), @pkc1_expectations);
cert_contains_all(srctop_file(@certs, "platcertv2.cert.pem"), @pkc2_expectations);

# TODO: Test attribute certificate-based platform certificates once printing
# attribute certificates is supported.
