## -*- mode: perl; -*-
## DSLLVM Configuration Targets
##
## This file defines build configurations for DSMIL-grade OpenSSL builds
## using the DSLLVM compiler (hardened LLVM/Clang fork with CSNA 2.0 support).
##
## Two build variants are defined:
##  - dsllvm-world:  Portable build (x86-64-v3) for internet compatibility (WORLD_COMPAT)
##  - dsllvm-dsmil:  Meteorlake-optimized build for internal DSMIL infrastructure
##
## See: OPENSSL_SECURE_SPEC.md for full specification

%targets = (

#### DSLLVM World Build (Portable, Internet-Compatible) ####

    "dsllvm-world" => {
        inherit_from     => [ "linux-x86_64" ],
        CC               => "dsclang",
        CXX              => "dsclang++",

        # Portable build flags per OPENSSL_SECURE_SPEC.md Section 4.1
        CFLAGS           => picker(
            debug   => "-O0 -g",
            release => "-O2"
        ),
        cflags           => add(
            "-pipe",
            "-march=x86-64-v3",          # Portable baseline: AVX2, BMI, FMA
            "-fstack-protector-strong",   # Stack protection
            "-fPIE",                      # Position Independent Executable
            "-fdata-sections",            # Function/data sections for gc
            "-ffunction-sections",
            "-flto=full",                 # Link-Time Optimization
        ),

        # DSLLVM-specific CSNA 2.0 flags
        cppflags         => add(
            "-D_FORTIFY_SOURCE=2",        # Runtime buffer overflow protection
            "-DDSLLVM_BUILD",             # Mark as DSLLVM build
            "-DCSNA_CONSTANT_TIME_CHECK", # Enable constant-time enforcement
        ),

        # Hardened linker flags
        lflags           => add(
            "-Wl,-z,relro",               # Relocation Read-Only
            "-Wl,-z,now",                 # Immediate binding (no lazy)
            "-Wl,--gc-sections",          # Garbage collect unused sections
            "-Wl,-plugin-opt=O2",         # LTO optimization level
        ),

        # Build options aligned with security profile
        ex_libs          => add("-ldl", threads("-pthread")),

        # Architecture config
        lib_cppflags     => add("-DL_ENDIAN"),
        bn_ops           => "SIXTY_FOUR_BIT_LONG",
        asm_arch         => 'x86_64',
        perlasm_scheme   => "elf",
        multilib         => "64",

        # Shared library support
        shared_cflag     => "-fPIC",
        shared_ldflag    => add_before("-shared"),
        shared_extension => ".so.\$(SHLIB_VERSION_NUMBER)",
    },

#### DSLLVM DSMIL Build (Meteorlake-Optimized, Internal Use) ####

    "dsllvm-dsmil" => {
        inherit_from     => [ "dsllvm-world" ],

        # Meteorlake-optimized build flags per OPENSSL_SECURE_SPEC.md Section 4.1
        CFLAGS           => picker(
            debug   => "-O0 -g",
            release => "-O3"              # Aggressive optimization
        ),
        cflags           => add(
            "-pipe",
            "-march=meteorlake",          # Target Intel Meteor Lake specifically
            "-mtune=meteorlake",          # Tune for Meteor Lake microarchitecture
            "-mavx2",                     # Enable AVX2 instructions
            "-mfma",                      # Enable FMA (Fused Multiply-Add)
            "-mavxvnni",                  # Enable AVX-VNNI
            "-maes",                      # Enable AES-NI instructions
            "-mvaes",                     # Enable VAES (Vector AES)
            "-mpclmulqdq",                # Enable PCLMULQDQ (carryless multiply)
            "-fomit-frame-pointer",       # Omit frame pointer for performance
            "-funroll-loops",             # Loop unrolling
            "-fstrict-aliasing",          # Strict aliasing rules
            "-fno-plt",                   # No PLT for better perf
            "-fstack-protector-strong",   # Stack protection
            "-fPIE",                      # Position Independent Executable
            "-fdata-sections",
            "-ffunction-sections",
            "-flto=full",                 # Link-Time Optimization
        ),

        # DSMIL-specific CSNA 2.0 flags (enhanced)
        cppflags         => add(
            "-D_FORTIFY_SOURCE=2",
            "-DDSLLVM_BUILD",
            "-DCSNA_CONSTANT_TIME_CHECK",  # Constant-time enforcement
            "-DCSNA_SIDE_CHANNEL_ALERT",   # Side-channel alerting mode
            "-DDSMIL_OPTIMIZED",           # Mark as DSMIL-optimized build
        ),

        # Hardened linker flags with LTO optimization
        lflags           => add(
            "-Wl,-z,relro",
            "-Wl,-z,now",
            "-Wl,--gc-sections",
            "-Wl,-plugin-opt=O3",         # Aggressive LTO optimization
            "-flto=full",                 # Full LTO at link time
        ),
    },

#### DSLLVM Debug Builds (for development) ####

    "dsllvm-world-debug" => {
        inherit_from     => [ "dsllvm-world" ],
        cflags           => add("-DDEBUG_BUILD"),
    },

    "dsllvm-dsmil-debug" => {
        inherit_from     => [ "dsllvm-dsmil" ],
        cflags           => add("-DDEBUG_BUILD"),
    },
);

## Configuration Notes:
##
## 1. DSCLANG Compiler:
##    The 'dsclang' compiler must be DSLLVM (hardened LLVM/Clang fork).
##    For development/testing, you can alias 'clang' as 'dsclang':
##      $ ln -s $(which clang) /usr/local/bin/dsclang
##      $ ln -s $(which clang++) /usr/local/bin/dsclang++
##
## 2. CSNA 2.0 Flags:
##    - CSNA_CONSTANT_TIME_CHECK: Enforces constant-time on annotated functions
##    - CSNA_SIDE_CHANNEL_ALERT: Warns on branches on secret data
##    These require DSLLVM; standard clang will ignore them (no-op).
##
## 3. Meteorlake Target:
##    The '-march=meteorlake' requires clang 19+ or DSLLVM with Meteor Lake support.
##    Fall back to '-march=x86-64-v4' if meteorlake is not recognized.
##
## 4. Security Features:
##    - PIE: Position Independent Executable (ASLR)
##    - RELRO/NOW: Prevents GOT overwrite attacks
##    - Stack Protector: Detects stack buffer overflows
##    - FORTIFY_SOURCE: Runtime buffer overflow detection
##    - gc-sections: Removes unused code
##
## 5. Usage Examples:
##
##    Configure for WORLD (portable) build:
##      $ ./Configure dsllvm-world --prefix=/opt/openssl-world \
##        --openssldir=/opt/openssl-world/ssl
##
##    Configure for DSMIL (optimized) build:
##      $ ./Configure dsllvm-dsmil --prefix=/opt/openssl-dsmil \
##        --openssldir=/opt/openssl-dsmil/ssl
##
##    Build and test:
##      $ make -j$(nproc)
##      $ make test
##      $ sudo make install
##
## 6. Related Documentation:
##    - OPENSSL_SECURE_SPEC.md: Full security specification
##    - IMPLEMENTATION_PLAN.md: Implementation roadmap
##    - Configurations/README.md: OpenSSL configuration guide
